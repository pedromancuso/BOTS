PubSubClient client(espClient);
char SERVER[50];char TOPIC[50];char PASSWORD[50];char PLACA[50];char valueStr[15];
String USERNAME;
int SERVERPORT;
////////////////////////////////RECONNECT//////////////////////////////////////////////////////////////////////////
////////////////////////////////RECONNECT//////////////////////////////////////////////////////////////////////////
////////////////////////////////RECONNECT//////////////////////////////////////////////////////////////////////////
////////////////////////////////RECONNECT//////////////////////////////////////////////////////////////////////////
void reconnect() {
  int retries = 0;
  if(!client.connected() && retries <2){
    retries++;
    Serial.print("Intentando conexion MQTT...");
    String clientId = "ESP8266Client-"+String(random(0xffff), HEX);
    USERNAME.toCharArray(PLACA, 50);
    if(client.connect("",PLACA, PASSWORD)){
      Serial.println("Conectado");
      client.subscribe(TOPIC);//////////////////////SUSCRIBE
    }else{
      Serial.print("Fallo, rc=" + String(client.state())+" Intenta nuevamente en 3 segundos");
      delay(3000);
    }
  }
}
////////////////////////////////PUBLISH//////////////////////////////////////////////////////////////////////////
////////////////////////////////PUBLISH//////////////////////////////////////////////////////////////////////////
String mqttpublish(String strtopic){
  strtopic.toCharArray(valueStr, 15);
  client.publish(TOPIC, valueStr);
  return "Enviando: [" +  String(TOPIC) + "] " + strtopic;
}
////////////////////////////////CALLBACK//////////////////////////////////////////////////////////////////////////
////////////////////////////////CALLBACK//////////////////////////////////////////////////////////////////////////
void callback(char* callbacktopic, byte* payload, unsigned int length) {
  String PAYLOAD = "";
  for (int i = 0; i < length; i++) {PAYLOAD += (char)payload[i];}
  Serial.print("Mensaje Recibido: ["+String(callbacktopic)+"]: ");Serial.println(PAYLOAD);
  if (PAYLOAD == "1I"){digitalWrite(LED_BUILTIN, LOW);}
  if (PAYLOAD == "1O"){digitalWrite(LED_BUILTIN, HIGH);}
}
////////////////////////////////MQTTCLIENTHANDLE//////////////////////////////////////////////////////////////////////////
////////////////////////////////MQTTCLIENTHANDLE//////////////////////////////////////////////////////////////////////////
////////////////////////////////MQTTCLIENTHANDLE//////////////////////////////////////////////////////////////////////////
////////////////////////////////MQTTCLIENTHANDLE//////////////////////////////////////////////////////////////////////////
void mqttclienthandle(){  
  client.setServer(SERVER, SERVERPORT);
  client.setCallback(callback);
  if (!client.connected()){reconnect();}
  client.loop();
}
